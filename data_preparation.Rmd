---
title: "BPNSS data preparation"
output: html_notebook
---

# Introduction
In this R notebook, we prepare the data for the Barcelona Summer School.
We begin with a subset of the road network data developed by the Minerva Project at Aarhus University
We transform it into directly usable road data for our exploratory network analysis and visualisation and uncertainty quantification experiments.

# Structure
The markdown is structured as follows:
1. We load the necessary packages and data
2. We clean the network data
3. We export the network data

# Preliminaries
## R version and packages
This document uses R version 4.3.0 (2023-04-21 ucrt). 
It relies on the following packages:
```{r list required packages}
required_packages <- c("tidyverse",
                       "sf",
                       "igraph",
                       "sfnetworks",
                       "raster",
                       "tidygraph"#,
                       #"RColorBrewer",
                       #"cowplot",
                       #"units"
                       )
```

SELECT WHAT IS NEEDED
*tidyverse* is a collection of packages for data analysis, that we use for data cleaning and visualisation. We use *sf* to read and handle shapefiles and *raster* to manage the coordinate projections. Finally, we adopt *igraph* to construct and export our network objects. *sfnetworks* transforms shapefiles into networks. For visualisation purposes, we include *RColorBrewer*, which manages colour palette, and *cowplot*, which extends the functionalities of *ggplot2* (included in tidyverse). *units* allows to specify units of measurements. 

One needs to install them if they are not installed yet.
```{r install packages}
packages_to_install <- required_packages[!(required_packages %in% installed.packages()[,"Package"])]
if(length(packages_to_install)) install.packages(packages_to_install)
```

Finally, one needs to load them
```{r load required packages}
invisible(lapply(required_packages, library, character.only = TRUE))
```

SELECT WHAT IS NEEDED
Note that we use the following versions of the packages:
* tidyverse  2.0.0
* sf         1.0.13
* raster     3.6.26
* igraph     1.4.3
* sfnetworks 0.6.3
* RColorBrewer 1.1.3
* tidygraph  1.2.3
* cowplot    1.1.3
* units      0.8.2

If a package has been updated since the release of this code, using the newer version may cause issues.
If this is the case, one can try to solve them by installing the specific versions of the packages by uncommenting and running the following code. 
Note, however, that these older versions of the packages may not be available for newer versions of R, in which case it will be necessary to switch to an older version of R to run the code (please refer to the cran.r website on how to do that: https://cran.r-project.org/index.html).
```{r use older versions of packages if needed}
# #install devtools if not already installed
# if (!"devtools" %in% installed.packages()[,"Package"]) install.packages("devtools")
# 
# #load devtools
# library(devtools)
# 
# #install specific versions of the packages
# install_version("tidyverse", version = "2.0.0")
# install_version("sf", version = "1.0.13")
# install_version("raster", version = "3.6.26")
# install_version("igraph", version = "1.4.3")
# install_version("sfnetworks", version = "0.6.3")
# install_version("RColorBrewer", version = "1.1.3")
# install_version("tidygraph", version = "1.2.3")
# install_version("cowplot", version = "1.1.3")
# install_version("units", version = "0.8.2")
# 
# #load packages
# invisible(lapply(required_packages, library, character.only = TRUE))
```

## Data 
We begin by loading the road data. This is an extract of the road network data developed by the Minerva Project at Aarhus University. Remark that we discard the z dimension, which we shall not use in this work.
```{r load the road data}
roads_catalonia <- read_sf("data/shp_roads_raw/roads_catalonia.shp") %>% 
  st_zm(drop = TRUE)
roads_catalonia_buffered <- read_sf("data/shp_roads_raw/roads_catalonia_buffered.shp") %>% 
  st_zm(drop = TRUE)
```

We clean it in a way that makes it suitable to be transformed into a network
```{r cast data to linestrings}
# cast the multilines to linestrings
roads_catalonia <- st_cast(roads_catalonia, to = "LINESTRING")
roads_catalonia_buffered <- st_cast(roads_catalonia_buffered, to = "LINESTRING")

# give reasonable names to the attributes
names(roads_catalonia) <- c("name","type","certainty","geometry")
names(roads_catalonia_buffered) <- c("name","type","certainty","geometry")
```

We add a length attribute which we will use in the analysis
```{r add length attribute}
roads_catalonia$length <- st_length(roads_catalonia)
roads_catalonia_buffered$length <- st_length(roads_catalonia_buffered)
```

Add estimates of construction date. Note: these are random and not historically based.
```{r add construction dates}
# set seed for reproducibility
set.seed(123)

# initialise data frame with road names
roads_construction_dates <- data.frame(name = unique(roads_catalonia_buffered$name))

# add earliest date, picked uniformly at random
roads_construction_dates$earliest_date <- sample(-20:50, 
                                                 nrow(roads_construction_dates), 
                                                 replace= TRUE)


# add most likely date, as the earliest date plus a vandom value between 1 and 10 years
roads_construction_dates$likeliest_date <- roads_construction_dates$earliest_date +
  sample(1:10, 
         nrow(roads_construction_dates),
         replace= TRUE)

# define the latest date as the earliest date plus a random value between 11 and 20 years
roads_construction_dates$latest_date <- roads_construction_dates$earliest_date +
  sample(11:20, 
         nrow(roads_construction_dates),
         replace= TRUE)

# merge with info with the sfs
roads_catalonia <- roads_catalonia %>% left_join(roads_construction_dates)
roads_catalonia_buffered <- roads_catalonia_buffered %>% left_join(roads_construction_dates)
```


For visualisation purposes, we use an openly available map of the globe. 
```{r world map for visualisation}
# download file
url <- "https://public.opendatasoft.com/api/explore/v2.1/catalog/datasets/world-administrative-boundaries/exports/shp"
destfile <- "data/shp_base_map.zip"  
download.file(url, destfile, mode = "wb")  # 'wb' for binary files

# Unzip the file
unzip(destfile, exdir = "data/shp_base_map") 

# read data
world_sf <- read_sf("data/shp_base_map/world-administrative-boundaries.shp") 

# dissolve administrative boundaries
world_sf <- st_union(world_sf) 
```


DO THE SAME FOR CATALONIA TO DO
```{r}
catalonia_sf <- read_sf("data/shp_base_map/catalonia.shp")
```


# Network data construction
The following function transforms the shapefiles into networks.
Since we limited ourselves to a specific geographical area, this might have introduced spurious fragmentation of the shapefile and thus of the network.
We thus only extract the main network component.
```{r}
# define a function that returns the largest component of a network
largest_component <- function(sf){
  # transform sf into an undirected network
  g <- as_sfnetwork(sf, directed = FALSE)
  
  # Find the components of the graph
  components <- components(g)

  # Identify the largest component
  largest_component_id <- which.max(components$csize)

  # Extract the vertex ids of the largest component
  largest_component_vertices <- which(components$membership == largest_component_id)

  # Create a subgraph containing only the largest component
  largest_component <- subgraph(g, largest_component_vertices)
  
  # Transform into a sf network to retain the spatial structure
  largest_component <- as_sfnetwork(largest_component)
  
  # return the result
  return(largest_component)
}

# apply the function to the above networks
net_catalonia <- largest_component(roads_catalonia) 
net_catalonia_buffered <- largest_component(roads_catalonia_buffered)
```

# Network data for uncertainty quantification
To demonstrate the impact of data uncertainty, we delete fragments of the secondary Iesso-Ad Fines road (Note to self: we might also want to try the "Manresa-Tona" road)
```{r create sf with deleted road segments}
# delete entire roads
roads_catalonia_mt <- roads_catalonia[!roads_catalonia$name=="Manresa-Tona",]
roads_catalonia_iaf <- roads_catalonia[!roads_catalonia$name=="Iesso-Ad Fines",]

# identify indices of road fragments corresponding to the Iesso-Ad Fines road 
Iesso_ad_fines_indices <- which(roads_catalonia$name == "Iesso-Ad Fines")

# create a list of sf, each with one of the fragments removed
roads_catalonia_iaf_list <- list()
for (i in 1:length(Iesso_ad_fines_indices)){
  roads_catalonia_iaf_list[[i]] <- roads_catalonia[c(1:(Iesso_ad_fines_indices[i]-1),
                                         (Iesso_ad_fines_indices[i]+1):nrow(roads_catalonia)),]
}
```

We transform them into networks as above
```{r create networks for uncertainty quantification}
net_catalonia_mt <- largest_component(roads_catalonia_mt)
net_catalonia_iaf <- largest_component(roads_catalonia_iaf)
net_catalonia_iaf_list <- lapply(roads_catalonia_iaf_list,largest_component)
```

# Export network data TO DO 
```{r}
#write_graph(net_catalonia,"data/networks/net_catalonia.graphml",format = "graphml")

# Extract nodes and edges from the sfnetwork
net_catalonia_nodes <- activate(net_catalonia, "nodes") %>% st_as_sf()
net_catalonia_edges <- activate(net_catalonia, "edges") %>% st_as_sf()

# Save nodes and edges to ESRI Shapefile
st_write(net_catalonia_nodes, "data/networks/net_catalonia_nodes.shp", delete_layer = TRUE)
st_write(net_catalonia_edges, "data/networks/net_catalonia_edges.shp", delete_layer = TRUE)

# Read nodes and edges from shapefiles
nodes_a <- st_read("data/networks/net_catalonia_nodes.shp")
edges_a <- st_read("data/networks/net_catalonia_edges.shp")

# read the sf
network_a <- sfnetwork(nodes_a, edges_a, directed = FALSE)
```


```{r}
net <- net_catalonia_iaf_list[[2]] %>%
  activate("edges") %>%
  mutate(weight = edge_length()) %>%
  activate("nodes") %>%
  mutate(bc = centrality_betweenness(weights = weight, directed = FALSE))

nodes_sf <- st_as_sf(net, "nodes")
edges_sf <- st_as_sf(net, "edges")
nodes_4326_sf <- nodes_sf %>% st_transform(crs=crs(world_sf))
edges_4326_sf <- edges_sf %>% st_transform(crs=crs(world_sf))

net_nodes_4326_coordinates <- nodes_4326_sf$geometry %>% st_coordinates()
min_lon <- min(net_nodes_4326_coordinates[,1])
max_lon <- max(net_nodes_4326_coordinates[,1])
min_lat <- min(net_nodes_4326_coordinates[,2])
max_lat <- max(net_nodes_4326_coordinates[,2])

ggplot() +
  geom_sf(data = world_sf, fill = "grey80") +
  geom_sf(data= catalonia_sf, fill= "grey100") +
  geom_sf(data = edges_4326_sf, col = "grey60") +
  geom_sf(data = nodes_4326_sf, aes(col = bc, size = bc)) +
  coord_sf(xlim = c(min_lon-0.5, max_lon+0.5), 
             ylim = c(min_lat-0.5, max_lat+0.5)) +
  theme_minimal() +
  ggtitle("Betweenness centrality in Catalonia")
```



